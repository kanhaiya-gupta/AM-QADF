name: Nightly Build

on:
  schedule:
    # Run every Sunday at 2 AM UTC (weekly)
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  nightly-tests:
    name: Nightly Test Suite
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1 libglib2.0-0 build-essential cmake ninja-build libtbb-dev libblosc-dev zlib1g-dev libsasl2-dev libsnappy-dev libzstd-dev libboost-iostreams-dev

    - name: Restore Boost 1.82 build cache
      id: boost182
      uses: actions/cache@v4
      with:
        path: boost_1_82_install
        key: boost-1.82-${{ runner.os }}-v1

    - name: Build Boost 1.82 (iostreams only) for OpenVDB
      if: steps.boost182.outputs.cache-hit != 'true'
      run: |
        set -e
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        mkdir -p boost_build && cd boost_build
        curl -sSL -o boost_1_82_0.tar.bz2 https://archives.boost.org/release/1.82.0/source/boost_1_82_0.tar.bz2
        tar -xjf boost_1_82_0.tar.bz2
        cd boost_1_82_0
        ./bootstrap.sh --prefix="$BOOST_PREFIX"
        ./b2 --with-iostreams link=shared variant=release threading=multi -j$(nproc) install
        cd ../..
        echo "Boost 1.82 (iostreams) installed to $BOOST_PREFIX"

    - name: Set Boost 1.82 lib path for linker
      run: |
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        echo "LIBRARY_PATH=${BOOST_PREFIX}/lib:${SYS_LIB}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${BOOST_PREFIX}/lib:${SYS_LIB}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV

    - name: Restore libiconv build cache
      id: libiconv
      uses: actions/cache@v4
      with:
        path: libiconv_install
        key: libiconv-1.17-${{ runner.os }}-v1

    - name: Build libiconv for ITK gdcm
      if: steps.libiconv.outputs.cache-hit != 'true'
      run: |
        set -e
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        mkdir -p libiconv_build && cd libiconv_build
        curl -sSL -o libiconv-1.17.tar.gz https://ftp.gnu.org/gnu/libiconv/libiconv-1.17.tar.gz
        tar -xzf libiconv-1.17.tar.gz
        cd libiconv-1.17
        ./configure --prefix="$ICONV_PREFIX"
        make -j$(nproc)
        make install
        cd "${{ github.workspace }}"
        echo "libiconv installed to $ICONV_PREFIX"

    - name: Set libiconv lib path for linker
      run: |
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        LIB_PATHS="${ICONV_PREFIX}/lib:${BOOST_PREFIX}/lib:${SYS_LIB}"
        echo "LIBRARY_PATH=${LIB_PATHS}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${LIB_PATHS}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV

    - name: Install pybind11
      run: pip install pybind11

    - name: Download third-party dependencies from release
      env:
        THIRD_PARTY_TAG: v0.2.0
      run: |
        set -e
        REPO="${{ github.repository }}"
        TAG="${THIRD_PARTY_TAG}"
        ZIP_URL="https://github.com/${REPO}/releases/download/${TAG}/third_party_install.zip"
        echo "Downloading ${ZIP_URL} ..."
        curl -sSL -o third_party_install.zip "$ZIP_URL"
        unzip -o third_party_install.zip
        mkdir -p third_party/openvdb third_party/ITK third_party/mongo-cxx-driver
        if [ -d "third_party_install" ]; then
          for name in openvdb ITK mongo-cxx-driver; do
            if [ -d "third_party_install/${name}/install" ]; then
              mv "third_party_install/${name}/install" "third_party/${name}/install"
            else
              mv "third_party_install/${name}" "third_party/${name}/install"
            fi
          done
        else
          mv openvdb third_party/openvdb/install
          mv ITK third_party/ITK/install
          mv mongo-cxx-driver third_party/mongo-cxx-driver/install
        fi
        echo "Third-party installs ready."

    - name: Patch conda paths in third_party
      run: |
        set -e
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        find third_party -type f \( -name "*.cmake" -o -name "*.pc" -o -name "*.h" \) -exec sed -i \
          -e "s|/home/[^/]*/miniconda3/[^\"']*x86_64-conda-linux-gnu/sysroot/usr/lib|${SYS_LIB}|g" \
          -e "s|/home/[^/]*/miniconda3/[^\"']*envs/[^/]*/lib|${SYS_LIB}|g" \
          {} \;
        echo "Patched conda paths."

    - name: SASL soname compat (libsasl2.so.3 for mongoc)
      run: |
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        SASL_COMPAT="${{ github.workspace }}/sasl_compat"
        mkdir -p "$SASL_COMPAT"
        if [ ! -f "${SYS_LIB}/libsasl2.so.3" ] && [ -f "${SYS_LIB}/libsasl2.so.2" ]; then
          ln -sf "${SYS_LIB}/libsasl2.so.2" "${SASL_COMPAT}/libsasl2.so.3"
          echo "SASL_COMPAT=${SASL_COMPAT}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${SASL_COMPAT}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${SASL_COMPAT}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "SASL compat: libsasl2.so.3 -> system libsasl2.so.2"
        fi

    - name: Configure and build C++
      run: |
        rm -rf build
        mkdir -p build && cd build
        OPENVDB_ROOT="${{ github.workspace }}/third_party/openvdb/install"
        ITK_DIR="${{ github.workspace }}/third_party/ITK/install/lib/cmake/ITK-6.0"
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        SASL_COMPAT="${{ github.workspace }}/sasl_compat"
        EXTRA="-DUSE_SYSTEM_LIBS=ON -DOpenVDB_ROOT=$OPENVDB_ROOT -DITK_DIR=$ITK_DIR"
        CMAKE_LIB_PATH="$SYS_LIB"
        [ -d "${SASL_COMPAT}" ] && [ -f "${SASL_COMPAT}/libsasl2.so.3" ] && CMAKE_LIB_PATH="${SASL_COMPAT}:${CMAKE_LIB_PATH}"
        [ -d "${BOOST_PREFIX}/lib" ] && CMAKE_LIB_PATH="${BOOST_PREFIX}/lib:${CMAKE_LIB_PATH}"
        [ -d "${ICONV_PREFIX}/lib" ] && CMAKE_LIB_PATH="${ICONV_PREFIX}/lib:${CMAKE_LIB_PATH}"
        [ -n "$CMAKE_LIB_PATH" ] && EXTRA="$EXTRA -DCMAKE_LIBRARY_PATH=${CMAKE_LIB_PATH}"
        cmake $EXTRA -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug -G Ninja ..
        cmake --build . -j $(nproc)

    - name: Export PYTHONPATH for am_qadf_native
      run: |
        NATIVE_DIR="${{ github.workspace }}/build/src/am_qadf_native"
        if [ -d "${NATIVE_DIR}/Debug" ]; then
          echo "PYTHONPATH=${NATIVE_DIR}/Debug${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        else
          echo "PYTHONPATH=${NATIVE_DIR}${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        fi

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run full test suite
      run: |
        pytest tests/ -v --tb=short --maxfail=5

    - name: Run unit tests
      run: |
        pytest tests/unit -m "unit" -v --tb=short

    - name: Run integration tests
      run: |
        pytest tests/integration -m "integration" -v --tb=short
      continue-on-error: true

    - name: Run e2e tests
      run: |
        pytest tests/e2e -m "e2e" -v --tb=short
      continue-on-error: true

    - name: Run property-based tests
      run: |
        pytest tests/property_based -m "property_based" -v --tb=short --no-cov
      continue-on-error: true

    - name: Run slow tests
      run: |
        pytest tests/ -m "slow" -v --no-cov || true
      continue-on-error: true

    - name: Run performance regression tests
      run: |
        pytest tests/performance/regression -m "performance" -v --tb=short --no-cov || true
      continue-on-error: true

  notebooks:
    name: Notebook Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install notebook dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jupyter ipywidgets nbconvert jupyterlab
    
    - name: Validate all notebooks
      run: |
        if [ -d "notebooks" ]; then
          python scripts/test_notebooks.py notebooks/ --mode validate
        else
          echo "‚ö†Ô∏è Notebooks directory not found - skipping validation"
        fi
      continue-on-error: true
    
    - name: Execute notebooks (check for runtime errors)
      run: |
        if [ -d "notebooks" ]; then
          echo "üöÄ Executing notebooks to check for runtime errors (nightly: first 10 notebooks)..."
          # For nightly builds, test a subset (first 10) to save time
          python scripts/test_notebooks.py notebooks/ --mode execute --limit 10
        else
          echo "‚ö†Ô∏è Notebooks directory not found - skipping execution"
        fi
      continue-on-error: true
      env:
        NUMBA_DISABLE_JIT: 1
        CI: true
        GITHUB_ACTIONS: true

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 pylint mypy bandit safety
    
    - name: Security check with bandit
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
      continue-on-error: true
    
    - name: Dependency vulnerability check
      run: |
        safety check --json || true
      continue-on-error: true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: bandit-report.json

