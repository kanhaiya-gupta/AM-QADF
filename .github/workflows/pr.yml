name: PR Checks

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number to check'
        required: false
        type: string
      branch:
        description: 'Target branch'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - develop
      run_quick_tests:
        description: 'Run quick validation tests'
        required: false
        default: true
        type: boolean
      run_format_check:
        description: 'Run format check'
        required: false
        default: true
        type: boolean
      execute_notebooks:
        description: 'Execute notebooks to check for errors'
        required: false
        default: false
        type: boolean

jobs:
  pr-checks:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event.inputs.run_quick_tests != 'false'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system C++ deps
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build libtbb-dev libblosc-dev zlib1g-dev libsasl2-dev libsnappy-dev libzstd-dev libboost-iostreams-dev

    - name: Restore Boost 1.82 build cache
      id: boost182
      uses: actions/cache@v4
      with:
        path: boost_1_82_install
        key: boost-1.82-${{ runner.os }}-v1

    - name: Build Boost 1.82 (iostreams only) for OpenVDB
      if: steps.boost182.outputs.cache-hit != 'true'
      run: |
        set -e
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        mkdir -p boost_build && cd boost_build
        curl -sSL -o boost_1_82_0.tar.bz2 https://archives.boost.org/release/1.82.0/source/boost_1_82_0.tar.bz2
        tar -xjf boost_1_82_0.tar.bz2
        cd boost_1_82_0
        ./bootstrap.sh --prefix="$BOOST_PREFIX"
        ./b2 --with-iostreams link=shared variant=release threading=multi -j$(nproc) install
        cd ../..
        echo "Boost 1.82 (iostreams) installed to $BOOST_PREFIX"

    - name: Set Boost 1.82 lib path for linker
      run: |
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        echo "LIBRARY_PATH=${BOOST_PREFIX}/lib:${SYS_LIB}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${BOOST_PREFIX}/lib:${SYS_LIB}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV

    - name: Restore libiconv build cache
      id: libiconv
      uses: actions/cache@v4
      with:
        path: libiconv_install
        key: libiconv-1.17-${{ runner.os }}-v1

    - name: Build libiconv for ITK gdcm
      if: steps.libiconv.outputs.cache-hit != 'true'
      run: |
        set -e
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        mkdir -p libiconv_build && cd libiconv_build
        curl -sSL -o libiconv-1.17.tar.gz https://ftp.gnu.org/gnu/libiconv/libiconv-1.17.tar.gz
        tar -xzf libiconv-1.17.tar.gz
        cd libiconv-1.17
        ./configure --prefix="$ICONV_PREFIX"
        make -j$(nproc)
        make install
        cd "${{ github.workspace }}"
        echo "libiconv installed to $ICONV_PREFIX"

    - name: Set libiconv lib path for linker
      run: |
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        LIB_PATHS="${ICONV_PREFIX}/lib:${BOOST_PREFIX}/lib:${SYS_LIB}"
        echo "LIBRARY_PATH=${LIB_PATHS}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${LIB_PATHS}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV

    - name: Install pybind11
      run: pip install pybind11

    - name: Download third-party dependencies from release
      env:
        THIRD_PARTY_TAG: v0.2.0
      run: |
        set -e
        REPO="${{ github.repository }}"
        TAG="${THIRD_PARTY_TAG}"
        ZIP_URL="https://github.com/${REPO}/releases/download/${TAG}/third_party_install.zip"
        echo "Downloading ${ZIP_URL} ..."
        curl -sSL -o third_party_install.zip "$ZIP_URL"
        unzip -o third_party_install.zip
        mkdir -p third_party/openvdb third_party/ITK third_party/mongo-cxx-driver
        if [ -d "third_party_install" ]; then
          for name in openvdb ITK mongo-cxx-driver; do
            if [ -d "third_party_install/${name}/install" ]; then
              mv "third_party_install/${name}/install" "third_party/${name}/install"
            else
              mv "third_party_install/${name}" "third_party/${name}/install"
            fi
          done
        else
          mv openvdb third_party/openvdb/install
          mv ITK third_party/ITK/install
          mv mongo-cxx-driver third_party/mongo-cxx-driver/install
        fi
        echo "Third-party installs ready."

    - name: Patch conda paths in third_party
      run: |
        set -e
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        find third_party -type f \( -name "*.cmake" -o -name "*.pc" -o -name "*.h" \) -exec sed -i \
          -e "s|/home/[^/]*/miniconda3/[^\"']*x86_64-conda-linux-gnu/sysroot/usr/lib|${SYS_LIB}|g" \
          -e "s|/home/[^/]*/miniconda3/[^\"']*envs/[^/]*/lib|${SYS_LIB}|g" \
          {} \;
        echo "Patched conda paths."

    - name: SASL soname compat (libsasl2.so.3 for mongoc)
      run: |
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        SASL_COMPAT="${{ github.workspace }}/sasl_compat"
        mkdir -p "$SASL_COMPAT"
        if [ ! -f "${SYS_LIB}/libsasl2.so.3" ] && [ -f "${SYS_LIB}/libsasl2.so.2" ]; then
          ln -sf "${SYS_LIB}/libsasl2.so.2" "${SASL_COMPAT}/libsasl2.so.3"
          echo "SASL_COMPAT=${SASL_COMPAT}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${SASL_COMPAT}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${SASL_COMPAT}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "SASL compat: libsasl2.so.3 -> system libsasl2.so.2"
        fi

    - name: Configure and build C++
      run: |
        rm -rf build
        mkdir -p build && cd build
        OPENVDB_ROOT="${{ github.workspace }}/third_party/openvdb/install"
        ITK_DIR="${{ github.workspace }}/third_party/ITK/install/lib/cmake/ITK-6.0"
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        SASL_COMPAT="${{ github.workspace }}/sasl_compat"
        EXTRA="-DUSE_SYSTEM_LIBS=ON -DOpenVDB_ROOT=$OPENVDB_ROOT -DITK_DIR=$ITK_DIR"
        CMAKE_LIB_PATH="$SYS_LIB"
        [ -d "${SASL_COMPAT}" ] && [ -f "${SASL_COMPAT}/libsasl2.so.3" ] && CMAKE_LIB_PATH="${SASL_COMPAT}:${CMAKE_LIB_PATH}"
        [ -d "${BOOST_PREFIX}/lib" ] && CMAKE_LIB_PATH="${BOOST_PREFIX}/lib:${CMAKE_LIB_PATH}"
        [ -d "${ICONV_PREFIX}/lib" ] && CMAKE_LIB_PATH="${ICONV_PREFIX}/lib:${CMAKE_LIB_PATH}"
        [ -n "$CMAKE_LIB_PATH" ] && EXTRA="$EXTRA -DCMAKE_LIBRARY_PATH=${CMAKE_LIB_PATH}"
        cmake $EXTRA -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug -G Ninja ..
        cmake --build . -j $(nproc)

    - name: Export PYTHONPATH for am_qadf_native
      run: |
        NATIVE_DIR="${{ github.workspace }}/build/src/am_qadf_native"
        if [ -d "${NATIVE_DIR}/Debug" ]; then
          echo "PYTHONPATH=${NATIVE_DIR}/Debug${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        else
          echo "PYTHONPATH=${NATIVE_DIR}${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        fi

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check for test files
      run: |
        if [ -z "$(find tests/ -name 'test_*.py' -type f)" ]; then
          echo "‚ö†Ô∏è Warning: No test files found"
        else
          echo "‚úì Test files found"
        fi
    
    - name: Run quick validation tests
      run: |
        pytest tests/unit -m "unit" -v --tb=line -x
    
    - name: Check import structure
      run: |
        python -c "import sys; sys.path.insert(0, '.'); from am_qadf import *; print('‚úì Imports work correctly')" || echo "‚ö†Ô∏è Import check failed, but continuing"
      continue-on-error: true
    
    - name: Validate pytest configuration
      run: |
        pytest --collect-only -q || true
    
    - name: Quick notebook validation
      run: |
        if [ -d "notebooks" ]; then
          NOTEBOOK_COUNT=$(find notebooks -name "*.ipynb" | wc -l)
          echo "Found $NOTEBOOK_COUNT notebook(s) in PR"
          python scripts/test_notebooks.py notebooks/ --mode validate
        else
          echo "No notebooks directory found - skipping"
        fi
      continue-on-error: true

    - name: Execute notebooks (if requested)
      if: github.event.inputs.execute_notebooks == 'true'
      run: |
        if [ -d "notebooks" ]; then
          echo "üöÄ Executing notebooks to check for runtime errors (PR: first 5 notebooks)..."
          # For PR checks, limit to first 5 notebooks to save time
          python scripts/test_notebooks.py notebooks/ --mode execute --timeout 180 --limit 5
        else
          echo "‚ö†Ô∏è Notebooks directory not found - skipping execution"
        fi
      continue-on-error: true
      env:
        NUMBA_DISABLE_JIT: 1
        CI: true
        GITHUB_ACTIONS: true

  format-check:
    name: Code Format Check
    runs-on: ubuntu-latest
    if: github.event.inputs.run_format_check != 'false'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Black
      run: |
        pip install black
    
    - name: Check code formatting
      run: |
        black --check src/ tests/ || (echo "‚ùå Code formatting issues found. Run 'black src/ tests/' to fix." && exit 1)
    
    - name: Comment PR with formatting suggestions
      if: failure()
      uses: actions/github-script@v6
      continue-on-error: true  # Allow failure in local act runs (no GitHub token)
      with:
        script: |
          const prNumber = parseInt('${{ github.event.inputs.pr_number }}');
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚ö†Ô∏è Code formatting issues detected. Please run `black src/ tests/` to format your code.'
          })


