name: CI

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run CI on'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - develop
          - all
      run_tests:
        description: 'Run test suites'
        required: false
        default: true
        type: boolean
      run_performance:
        description: 'Run performance tests'
        required: false
        default: false
        type: boolean
      execute_notebooks:
        description: 'Execute notebooks to check for errors'
        required: false
        default: false
        type: boolean
      cpp_only:
        description: 'Run only C++ build and test (skip Python tests, lint, etc.)'
        required: false
        default: false
        type: boolean

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: cpp
    if: github.event.inputs.cpp_only != 'true' && github.event.inputs.run_tests != 'false'
    env:
      NUMBA_DISABLE_JIT: 1
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']
    
    steps:
    - uses: actions/checkout@v4

    - name: Download am_qadf_native
      uses: actions/download-artifact@v4
      with:
        name: am_qadf_native

    - name: Set PYTHONPATH for am_qadf_native
      run: |
        NATIVE_DIR="${{ github.workspace }}/am_qadf_native"
        if [ -d "${NATIVE_DIR}/Debug" ]; then
          echo "PYTHONPATH=${NATIVE_DIR}/Debug${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        else
          echo "PYTHONPATH=${NATIVE_DIR}${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        fi
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1 libglib2.0-0
    
    - name: Install Python dependencies
      run: |
        export NUMBA_DISABLE_JIT=1
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        export NUMBA_DISABLE_JIT=1
        # Clear numba cache to prevent loading cached compiled code
        python -c "import numba; numba.config.DISABLE_JIT = True" 2>/dev/null || true
        pytest tests/unit -m "unit" -v --tb=short
    
    - name: Run integration tests
      run: |
        export NUMBA_DISABLE_JIT=1
        # Use parallel execution for faster tests (2 workers for GitHub Actions limited resources)
        pytest tests/integration -m "integration" -v --tb=short -n 2
      continue-on-error: true
    
    - name: Run e2e tests
      run: |
        export NUMBA_DISABLE_JIT=1
        pytest tests/e2e -m "e2e" -v --tb=short
      continue-on-error: true
    
    - name: Run property-based tests
      run: |
        export NUMBA_DISABLE_JIT=1
        pytest tests/property_based -m "property_based" -v --tb=short --no-cov
      continue-on-error: true
    
    - name: Run utils tests
      run: |
        export NUMBA_DISABLE_JIT=1
        # Utils tests don't test source code, so no coverage needed
        pytest tests/utils -v --tb=short --no-cov
      continue-on-error: true
    
    - name: Run all tests with coverage
      run: |
        export NUMBA_DISABLE_JIT=1
        # Run all tests with coverage in parallel (2 workers for GitHub Actions)
        # Note: Coverage collection works with xdist but may be slightly less accurate
        pytest tests/ --cov=src/am_qadf --cov-report=xml --cov-report=term-missing --cov-report=html -v --cov-fail-under=15 -n 2
      continue-on-error: true
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  cpp:
    name: Build and test C++
    runs-on: ubuntu-latest
    if: github.event.inputs.cpp_only == 'true' || github.event.inputs.run_tests != 'false'
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python (for pybind11)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system C++ deps (no conda — TBB/system libs)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libtbb-dev \
          libblosc-dev \
          zlib1g-dev \
          libsasl2-dev \
          libsnappy-dev \
          libzstd-dev \
          libboost-iostreams-dev

    - name: Check Boost and key library versions
      run: |
        echo "=== Boost ==="
        dpkg -l | grep -E "libboost|^ii.*boost" || true
        ls -la /usr/lib/x86_64-linux-gnu/libboost_iostreams* 2>/dev/null || true
        pkg-config --modversion boost_iostreams 2>/dev/null || echo "pkg-config boost_iostreams: not found"
        echo "=== TBB ==="
        dpkg -l | grep -E "libtbb|^ii.*tbb" || true
        echo "=== GCC ==="
        g++ --version | head -1

    # Pre-built OpenVDB in zip was built against Boost 1.82; system has 1.74. Build Boost 1.82 (iostreams only) for link time.
    - name: Restore Boost 1.82 build cache
      id: boost182
      uses: actions/cache@v4
      with:
        path: boost_1_82_install
        key: boost-1.82-${{ runner.os }}-v1

    - name: Build Boost 1.82 (iostreams only) for OpenVDB
      if: steps.boost182.outputs.cache-hit != 'true'
      run: |
        set -e
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        mkdir -p boost_build && cd boost_build
        curl -sSL -o boost_1_82_0.tar.bz2 https://archives.boost.org/release/1.82.0/source/boost_1_82_0.tar.bz2
        tar -xjf boost_1_82_0.tar.bz2
        cd boost_1_82_0
        ./bootstrap.sh --prefix="$BOOST_PREFIX"
        ./b2 --with-iostreams link=shared variant=release threading=multi -j$(nproc) install
        cd ../..
        echo "Boost 1.82 (iostreams) installed to $BOOST_PREFIX"

    - name: Set Boost 1.82 lib path for linker
      run: |
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        LIB_PATHS="${BOOST_PREFIX}/lib:${SYS_LIB}"
        echo "LIBRARY_PATH=${LIB_PATHS}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${LIB_PATHS}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
        echo "Boost 1.82 lib path: ${BOOST_PREFIX}/lib"
        ls -la "${BOOST_PREFIX}/lib"/libboost* 2>/dev/null || true

    # Pre-built ITK (gdcm) needs libiconv.so.2; Ubuntu has no package. Build GNU libiconv for link time.
    - name: Restore libiconv build cache
      id: libiconv
      uses: actions/cache@v4
      with:
        path: libiconv_install
        key: libiconv-1.17-${{ runner.os }}-v1

    - name: Build libiconv for ITK gdcm
      if: steps.libiconv.outputs.cache-hit != 'true'
      run: |
        set -e
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        mkdir -p libiconv_build && cd libiconv_build
        curl -sSL -o libiconv-1.17.tar.gz https://ftp.gnu.org/gnu/libiconv/libiconv-1.17.tar.gz
        tar -xzf libiconv-1.17.tar.gz
        cd libiconv-1.17
        ./configure --prefix="$ICONV_PREFIX"
        make -j$(nproc)
        make install
        cd "${{ github.workspace }}"
        echo "libiconv installed to $ICONV_PREFIX"

    - name: Set libiconv lib path for linker
      run: |
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        LIB_PATHS="${ICONV_PREFIX}/lib:${BOOST_PREFIX}/lib:${SYS_LIB}"
        echo "LIBRARY_PATH=${LIB_PATHS}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${LIB_PATHS}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
        [ -d "${ICONV_PREFIX}/lib" ] && ls -la "${ICONV_PREFIX}/lib"/libiconv* 2>/dev/null || true

    - name: Install pybind11
      run: pip install pybind11

    # Third-party (OpenVDB, ITK, mongo-cxx-driver) from GitHub release — same for CI and local act
    - name: Download third-party dependencies from release
      env:
        THIRD_PARTY_TAG: v0.2.0
      run: |
        set -e
        REPO="${{ github.repository }}"
        TAG="${THIRD_PARTY_TAG}"
        ZIP_URL="https://github.com/${REPO}/releases/download/${TAG}/third_party_install.zip"
        echo "Downloading ${ZIP_URL} ..."
        curl -sSL -o third_party_install.zip "$ZIP_URL"
        unzip -o third_party_install.zip
        mkdir -p third_party/openvdb third_party/ITK third_party/mongo-cxx-driver
        if [ -d "third_party_install" ]; then
          # Zip layout: third_party_install/<name>/install/ (include, lib inside install)
          for name in openvdb ITK mongo-cxx-driver; do
            if [ -d "third_party_install/${name}/install" ]; then
              mv "third_party_install/${name}/install" "third_party/${name}/install"
            else
              mv "third_party_install/${name}" "third_party/${name}/install"
            fi
          done
        else
          mv openvdb third_party/openvdb/install
          mv ITK third_party/ITK/install
          mv mongo-cxx-driver third_party/mongo-cxx-driver/install
        fi
        echo "Third-party installs ready."

    # Pre-built zip may contain conda sysroot paths; replace with system lib paths
    - name: Patch conda paths in third_party
      run: |
        set -e
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        find third_party -type f \( -name "*.cmake" -o -name "*.pc" -o -name "*.h" \) -exec sed -i \
          -e "s|/home/[^/]*/miniconda3/[^\"']*x86_64-conda-linux-gnu/sysroot/usr/lib|${SYS_LIB}|g" \
          -e "s|/home/[^/]*/miniconda3/[^\"']*envs/[^/]*/lib|${SYS_LIB}|g" \
          {} \;
        echo "Patched conda paths."

    # Pre-built libmongoc2 expects libsasl2.so.3; Ubuntu has libsasl2.so.2. Symlink so linker finds libsasl2.so.3.
    - name: SASL soname compat (libsasl2.so.3 for mongoc)
      run: |
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        SASL_COMPAT="${{ github.workspace }}/sasl_compat"
        mkdir -p "$SASL_COMPAT"
        if [ ! -f "${SYS_LIB}/libsasl2.so.3" ] && [ -f "${SYS_LIB}/libsasl2.so.2" ]; then
          ln -sf "${SYS_LIB}/libsasl2.so.2" "${SASL_COMPAT}/libsasl2.so.3"
          echo "SASL_COMPAT=${SASL_COMPAT}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${SASL_COMPAT}:${LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${SASL_COMPAT}:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "SASL compat: libsasl2.so.3 -> system libsasl2.so.2"
        fi

    - name: Configure C++ build (system libs + third-party from release)
      run: |
        rm -rf build
        mkdir -p build && cd build
        OPENVDB_ROOT="${{ github.workspace }}/third_party/openvdb/install"
        ITK_DIR="${{ github.workspace }}/third_party/ITK/install/lib/cmake/ITK-6.0"
        BOOST_PREFIX="${{ github.workspace }}/boost_1_82_install"
        ICONV_PREFIX="${{ github.workspace }}/libiconv_install"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        SASL_COMPAT="${{ github.workspace }}/sasl_compat"
        EXTRA_ARGS="-DUSE_SYSTEM_LIBS=ON"
        [ -d "$OPENVDB_ROOT" ] && EXTRA_ARGS="$EXTRA_ARGS -DOpenVDB_ROOT=$OPENVDB_ROOT"
        [ -d "$ITK_DIR" ] && EXTRA_ARGS="$EXTRA_ARGS -DITK_DIR=$ITK_DIR"
        CMAKE_LIB_PATH="$SYS_LIB"
        [ -d "${SASL_COMPAT}" ] && [ -f "${SASL_COMPAT}/libsasl2.so.3" ] && CMAKE_LIB_PATH="${SASL_COMPAT}:${CMAKE_LIB_PATH}"
        [ -d "${BOOST_PREFIX}/lib" ] && CMAKE_LIB_PATH="${BOOST_PREFIX}/lib:${CMAKE_LIB_PATH}"
        [ -d "${ICONV_PREFIX}/lib" ] && CMAKE_LIB_PATH="${ICONV_PREFIX}/lib:${CMAKE_LIB_PATH}"
        [ -n "$CMAKE_LIB_PATH" ] && EXTRA_ARGS="$EXTRA_ARGS -DCMAKE_LIBRARY_PATH=${CMAKE_LIB_PATH}"
        cmake $EXTRA_ARGS \
          -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -G Ninja ..

    - name: Build C++
      run: |
        cd build
        cmake --build . -j $(nproc)

    - name: Run C++ tests
      run: |
        WS="${{ github.workspace }}"
        SYS_LIB="/usr/lib/x86_64-linux-gnu"
        LD_PATH="${WS}/third_party/openvdb/install/lib:${WS}/third_party/ITK/install/lib:${WS}/third_party/mongo-cxx-driver/install/lib"
        [ -d "${WS}/sasl_compat" ] && LD_PATH="${WS}/sasl_compat:${LD_PATH}"
        [ -d "${WS}/libiconv_install/lib" ] && LD_PATH="${WS}/libiconv_install/lib:${LD_PATH}"
        [ -d "${WS}/boost_1_82_install/lib" ] && LD_PATH="${WS}/boost_1_82_install/lib:${LD_PATH}"
        export LD_LIBRARY_PATH="${LD_PATH}:${SYS_LIB}:${LD_LIBRARY_PATH:-}"
        echo "LD_LIBRARY_PATH=${LD_LIBRARY_PATH}" >> $GITHUB_ENV
        cd build
        ctest --output-on-failure

    - name: Export PYTHONPATH for am_qadf_native
      run: |
        NATIVE_DIR="${{ github.workspace }}/build/src/am_qadf_native"
        if [ -d "${NATIVE_DIR}/Debug" ]; then
          echo "PYTHONPATH=${NATIVE_DIR}/Debug${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        else
          echo "PYTHONPATH=${NATIVE_DIR}${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        fi

    - name: Verify Python can import am_qadf_native
      run: python -c "import am_qadf_native; print('am_qadf_native OK')"

    - name: Upload am_qadf_native
      uses: actions/upload-artifact@v4
      with:
        name: am_qadf_native
        path: build/src/am_qadf_native

  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest
    if: github.event.inputs.cpp_only != 'true' && github.event.inputs.run_tests != 'false'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install linting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 pylint mypy
    
    - name: Check code formatting with Black
      run: |
        # Skip newline checks - newlines at end of file are not enforced
        black --check --diff src/ tests/ || echo "Black formatting check completed (newlines ignored)"
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: Lint with pylint
      run: |
        pylint src/ --disable=all --enable=E,F --exit-zero || true
      continue-on-error: true
    
    - name: Type check with mypy
      run: |
        mypy src/ --explicit-package-bases --ignore-missing-imports --no-strict-optional || true
      continue-on-error: true

  test-matrix:
    name: Test Suite Matrix
    runs-on: ubuntu-latest
    needs: cpp
    if: github.event.inputs.cpp_only != 'true' && github.event.inputs.run_tests != 'false'
    env:
      NUMBA_DISABLE_JIT: 1
    
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - tests/unit
          - tests/integration
          - tests/e2e
          - tests/property_based
          - tests/utils
    
    steps:
    - uses: actions/checkout@v4

    - name: Download am_qadf_native
      uses: actions/download-artifact@v4
      with:
        name: am_qadf_native

    - name: Set PYTHONPATH for am_qadf_native
      run: |
        NATIVE_DIR="${{ github.workspace }}/am_qadf_native"
        if [ -d "${NATIVE_DIR}/Debug" ]; then
          echo "PYTHONPATH=${NATIVE_DIR}/Debug${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        else
          echo "PYTHONPATH=${NATIVE_DIR}${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
        fi
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1 libglib2.0-0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run ${{ matrix.test-suite }} tests
      run: |
        export NUMBA_DISABLE_JIT=1
        # Utils and property_based tests don't need coverage (utils don't test source, property_based are supplementary)
        if [ "${{ matrix.test-suite }}" == "tests/utils" ] || [ "${{ matrix.test-suite }}" == "tests/property_based" ]; then
          pytest ${{ matrix.test-suite }} -v --tb=short --no-cov
        else
          pytest ${{ matrix.test-suite }} -v --tb=short
        fi
      continue-on-error: true

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.cpp_only != 'true' && github.event.inputs.run_performance == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1 libglib2.0-0
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run performance regression tests
      run: |
        pytest tests/performance/regression -m "performance" -v --tb=short --no-cov
      continue-on-error: true
    
    - name: Run performance benchmarks
      run: |
        pytest tests/performance/benchmarks -m "benchmark" --benchmark-only --benchmark-json=benchmark.json --no-cov || true
      continue-on-error: true
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true  # Allow failure if benchmark.json doesn't exist
      with:
        name: benchmark-results
        path: benchmark.json

  notebooks:
    name: Validate Notebooks
    runs-on: ubuntu-latest
    if: github.event.inputs.cpp_only != 'true' && github.event.inputs.run_tests != 'false'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1 libglib2.0-0
    
    - name: Install notebook dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jupyter ipywidgets nbconvert pytest-html
        pip install matplotlib numpy pandas scipy scikit-learn pyvista || true
    
    - name: Check notebook files exist
      run: |
        if [ ! -d "notebooks" ]; then
          echo "⚠️ Warning: notebooks directory not found"
          exit 0
        fi
        NOTEBOOK_COUNT=$(find notebooks -name "*.ipynb" | wc -l)
        echo "Found $NOTEBOOK_COUNT notebook(s)"
        if [ "$NOTEBOOK_COUNT" -eq 0 ]; then
          echo "⚠️ Warning: No notebooks found"
        fi
    
    - name: Validate notebook structure
      run: |
        if [ -d "notebooks" ]; then
          python scripts/test_notebooks.py notebooks/ --mode validate
        else
          echo "Skipping notebook validation - notebooks directory not found"
        fi
      continue-on-error: true
    
    - name: Check notebook dependencies
      run: |
        if [ -d "notebooks" ]; then
          python scripts/test_notebooks.py notebooks/ --mode check-deps
        fi
      continue-on-error: true
    
    - name: Validate notebook documentation
      run: |
        if [ -d "docs/Notebook" ]; then
          echo "✅ Notebook documentation directory found"
          DOC_COUNT=$(find docs/Notebook -name "*.md" | wc -l)
          echo "Found $DOC_COUNT documentation file(s)"
        else
          echo "⚠️ Warning: Notebook documentation directory not found"
        fi
      continue-on-error: true
    
    - name: Execute notebooks (check for runtime errors)
      if: github.event.inputs.execute_notebooks == 'true'
      run: |
        if [ -d "notebooks" ]; then
          python scripts/test_notebooks.py notebooks/ --mode execute
        else
          echo "⚠️ Notebooks directory not found - skipping execution"
        fi
      continue-on-error: true
      env:
        NUMBA_DISABLE_JIT: 1
        CI: true
        GITHUB_ACTIONS: true

