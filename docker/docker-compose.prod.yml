# Docker Compose for AM-QADF Framework
# Production environment with external services

version: '3.8'

services:
  # Note: In production, MongoDB and Spark are typically managed externally
  # This file is kept for reference and local production-like testing
  
  # MongoDB for Document Storage (AM-QADF Primary Database)
  # In production, use external MongoDB service
  mongodb:
    image: mongo:7.0
    container_name: am-qadf-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-am_qadf_data}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - am-qadf-network
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Apache Spark for Signal Mapping (Optional - for distributed processing)
  # In production, use external Spark cluster
  spark:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.spark
    container_name: am-qadf-spark
    environment:
      SPARK_APP_NAME: am-qadf-spark
      SPARK_MASTER: ${SPARK_MASTER:-local[*]}
      SPARK_DRIVER_MEMORY: ${SPARK_DRIVER_MEMORY:-2g}
      SPARK_EXECUTOR_MEMORY: ${SPARK_EXECUTOR_MEMORY:-2g}
      SPARK_EXECUTOR_CORES: ${SPARK_EXECUTOR_CORES:-2}
      PYTHONPATH: /opt/spark/src:/opt/spark/config
    ports:
      - "4040:4040"  # Spark UI
      - "7077:7077"  # Spark Master
    volumes:
      - ../../src:/opt/spark/src
      - ../../config:/opt/spark/config
      - ../../data:/opt/spark/data
      - spark_data:/opt/spark/data
    networks:
      - am-qadf-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4040"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'

# Volumes
volumes:
  mongodb_data:
    driver: local
  spark_data:
    driver: local

# Networks
networks:
  am-qadf-network:
    driver: bridge
    external: false
