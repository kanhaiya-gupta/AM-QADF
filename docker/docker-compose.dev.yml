# Docker Compose for AM-QADF Framework
# Local development environment with essential services

services:
  # MongoDB for Document Storage (AM-QADF Primary Database)
  mongodb:
    image: mongo:7.0
    container_name: am-qadf-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-am_qadf_data}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./init-scripts/mongodb:/docker-entrypoint-initdb.d
    networks:
      - am-qadf-network
    # Memory limits to prevent OOM kills
    deploy:
      resources:
        limits:
          memory: 4G  # Increase from default (usually 2G) for large batch processing
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Caching (Query Result Caching)
  redis:
    image: redis:7-alpine
    container_name: am-qadf-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    networks:
      - am-qadf-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Kafka for Messaging & Streaming (KRaft mode, no Zookeeper)
  kafka:
    image: bitnami/kafka:3.7
    container_name: am-qadf-kafka
    environment:
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
    ports:
      - "9092:9092"
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - am-qadf-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # AM-QADF Framework (Python app + optional API; build from repo root)
  # Note: Mounted repo includes third_party; host/container needs >6GB for third_party when present.
  am-qadf:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: am-qadf:dev
    container_name: am-qadf-app
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 1G
    environment:
      # am_qadf (src), am_qadf_native (after build), repo root
      PYTHONPATH: /workspace/build/src/am_qadf_native:/workspace/build/src/am_qadf_native/Debug:/workspace/build/src/am_qadf_native/Release:/workspace/src:/workspace
      MONGODB_URL: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DATABASE:-am_qadf_data}?authSource=admin
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      API_HOST: 0.0.0.0
      API_PORT: 8000
    volumes:
      - ..:/workspace
    ports:
      - "8000:8000"
    networks:
      - am-qadf-network
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    command: ["/bin/bash", "-c", "sleep infinity"]
    # Override to run API: command: ["python", "main.py"] (if client.app exists)
    # Or: docker exec -it am-qadf-app bash

# Volumes
volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  kafka_data:
    driver: local

# Networks
networks:
  am-qadf-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
